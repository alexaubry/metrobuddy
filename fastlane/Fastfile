default_platform(:ios)

platform :ios do
  desc "Generates screenshots and uploads them to the App Store"
  lane :screenshots do
    capture_screenshots
    frame_screenshots
    upload_to_app_store(
      skip_binary_upload: true,
      skip_metadata: true,
      skip_app_version_update: true
    )
  end

  desc "Runs tests"
  lane :test do
    run_tests(scheme: "MetroBuddy")
  end

  desc "Push a new release build to the App Store"
  lane :release do
    build_number = (latest_testflight_build_number + 1).to_s
    version = ENV['APP_VERSION']

    set_xcconfig_value(
        path: "Configs/Base.xcconfig",
        name: "CURRENT_PROJECT_VERSION",
        value: build_number
    )

    build_app(scheme: "MetroBuddy")
    upload_to_app_store(skip_metadata: true)

    git_commit(path: "./Configs/Base.xcconfig", message: "Version Bump")
    add_git_tag(tag: version + "-build." + build_number)
  end
end
